<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>jPlusUI 类图</title>
    <script src="../../../assets/demo/demo.js" type="text/javascript"></script>

    <style>
        body {
            font-family: 'Segoe UI',Verdana,Arial;
        }

        .object {
            border: 1px solid #716F64;
            border-radius: 10px;
            box-shadow: #D8D8D8 4px 4px;
            font-size: 14px;
            line-height: 20px;
            width: 150px;
            background: #fff;
        }

            .object header {
                background-image: linear-gradient(to right, #D3DCEF, #FEFFFF);
                font-weight: bold;
                border-radius: 10px 10px 0 0;
                font-size: 12px;
                padding: 6px 10px 10px;
                border-bottom: 1px solid #DFE1E3;
            }

                .object header a {
                    text-decoration: none;
                    color: #000;
                }

                    .object header a:hover {
                        text-decoration: underline;
                    }

        .interface header {
            background-image: linear-gradient(to right, #E6F0DB, #FEFFFF);
        }

        .object .collapse {
            float: right;
            width: 25px;
            height: 20px;
            background: url(assets/arrow.png) no-repeat right top;
            cursor: pointer;
        }

        .object header h4 {
            float: left;
            margin: 0;
            font-size: 16px;
            line-height: 20px;
        }
        
        .object header .type {
            clear: both;
        }

        .object dl {
            margin: 0 0 10px;
        }

        .object dt {
            background: #F0F2F9;
            font-size: 12px;
            padding: 0 5px;
            font-weight: 300;
        }

        .interface .object dt {
            background: #F3F7F0;
        }

        .object dd {
            margin-left: 0;
            line-height: 24px;
        }

            .object dd a {
                color: #000000;
                text-decoration: none;
                display: block;
            }

                .object dd a:hover {
                    background: #ebebeb;
                }

        .rightarrow {
            float: left;
            width: 18px;
            height: 20px;
            background: url(assets/arrow.png) no-repeat left bottom;
        }

        .collapsed header {
            border-radius: 10px;
        }

        .collapsed .collapse {
            background-position: 100% -20px;
        }

        .collapsed dl {
            display: none;
        }

        .icon-member {
            background: url(assets/icons.gif) no-repeat left center;
            width: 24px;
            height: 20px;
            margin-top: 4px;
            float: left;
        }

        .icon-none {
            width: 20px;
            background: none;
        }


        .icon-static {
            width: 20px;
            background-position: 100% 4px;
            background-image: url(assets/static.gif);
        }

        .icon-namespace {
            background-position: 0 0;
        }

        .icon-class {
            background-position: 0 -40px;
        }

        .icon-interface {
            background-position: 0 -80px;
        }

        .icon-method, .icon-function {
            background-position: 0 -160px;
        }

        .icon-property {
            background-position: 0 -200px;
        }

        .icon-field {
            background-position: 0 -240px;
        }

        .icon-event {
            background-position: 0 -280px;
        }

        .source {
            position: absolute;
            z-index: 1010;
            -webkit-background-clip: padding-box;
            -moz-background-clip: padding;
            background-clip: padding-box;
            border: 3px solid #333;
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 6px;
            -webkit-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            -moz-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            min-width: 200px;
        }

            .source .arrow {
                font-family: "SimSun";
                overflow: hidden;
                display: block;
                font-size: 21px;
                line-height: 20px;
                position: absolute;
                content: "\25c6";
                color: #000000;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                -o-user-select: none;
                user-select: none;
                height: 20px;
                width: 10px;
                left: -10px;
                top: 15px;
                color: #333;
                margin-top: -10px;
            }

            .source .arrow-back {
                position: absolute;
                top: 0;
                left: 1px;
            }

            .source pre {
                margin: 0;
            }

        .arrow-top, .arrow-circle {
            font-family: Arial, sans-serif;
            color: #716F64;
            font-size: 12px;
        }

        .arrow-circle {
            font-size: 35px;
        }

        .line-horizonal {
            height: 0;
            border-top: 1px solid #716F64;
        }

        .line-vertical {
            width: 0;
            border-left: 1px solid #716F64;
        }

        #body {
            width: 980px;
            overflow: auto;
            height: 600px;
            position: relative;
        }

        #body > * {
            position: absolute;
        }
    </style>

    <script>

        function getClasses() {

            /*

             {
                Class1: {
                    extends; '',
                    impelemts: ['IInput', 'IInput']
                    type: 'classs',
                    fields: {
                        'aaa': 1,
                        'gggg': 2,
                        'rrrr': 4
                    },
                    methods: {
                        'aaa': function(){}
                    },
                    events: {

                    }
                }
            */

            return {

                Class1: {
                    fields: {
                        'aaa': 1,
                        'gggg': 2,
                        'rrrr': 4
                    }
                },

                Class2: {
                    extend: 'Class1',
                    type: '类',
                    implements: ['IIgasdas', 'IIccad']  ,
                    fields: {
                        'aaa': 1,
                        'gggg': 2,
                        'rrrr': 4
                    },
                    methods: {
                        'aaa': function(){}
                    }
                },

                Class3: {
                    extend: 'Class1',
                    type: '类',
                    fields: {
                        'aaa': 1,
                        'gggg': 2,
                        'rrrr': 4
                    },
                    methods: {
                        'aaa': function(){}
                    }
                },

                Class7: {
                    extend: 'Class1',
                    type: '类',
                    fields: {
                        'aaa': 1,
                        'gggg': 2,
                        'rrrr': 4
                    },
                    methods: {
                        'aaa': function(){}
                    }
                }



            };

        }
        
        // 参数

        var simpleClassColumn = 9;
        var objectWidth = 150;
        var objectHeight = 37;
        var objectMarginRight = 30;
        var objectMarginBottom = 90;
        var implementHeight = 34;
        var implementOffset = 20;
        
        var members = {
          'field': '字段',
          'method': '方法',
          'event': '事件'
        };

        // 绘图

        // 分析类的列表并返回类树。
        function getClasssDom(classes) {

            var r = [];

            // 统计每个类的直接子类

            for (var className in classes) {

                var clazz = classes[className];

                clazz.name = className;

                // 如果存在继承，则放到对应父类的 children 属性。
                if (clazz.extend && classes[clazz.extend]) {

                    var parentClass = classes[clazz.extend];

                    // 第一次添加时，初始化 children 属性。
                    if (!parentClass.children) {
                        parentClass.children = [];
                    }

                    parentClass.children.push(clazz);

                } else {

                    // 否则，它被添加到全局数组里。
                    r.push(clazz);

                }

            }

            // 统计每个类的全部子类个数
            
            var maxRow = 0;

            getCount(r, 0);

            function getCount(children, row) {

                var count = 0;
                
                var col = 0;
                
                if(maxRow < row){
                    maxRow++;
                }

                for (var i = 0; i < children.length; i++) {
                    
                    children[i].row = row;
                    children[i].col = count;
                    
                    if (children[i].children) {
                        children[i].count = getCount(children[i].children, row + 1);
                        count += children[i].count;
                    } else {
                        children[i].count = 0;
                        count++;
                    }

                }

                return count;
            }
            
            for(var i = 0, col = 0; i < r.length; i++){
                
                if(r[i].count === 0){
                    
                    r[i].row = maxRow;
                    r[i].col = col;
                    
                    if(++col >= simpleClassColumn){
                        maxRow++;
                    }
                    
                }
                
            }

            return r;

            /*
 
            [
                name: 'Class1',
                type: '类',
                count: 5,
                children: [{
                    name: 'Class1',
                    type: '类',
                }]
            */
        }

        function paintClassDom(classes) {
            
            var classDom = getClasssDom(classes);
            
            var nonParent = [];

            // 每个类的宽度。
            var html = '';
            
            for (var i = 0; i < classDom.length; i++) {
                drawSignleObject(classDom[i]);
            }
            
            // 绘制单一的对象。
            function drawSignleObject(clazz) {
                
                var x = clazz.col * (objectWidth + objectMarginRight);
                var y = clazz.row * (objectHeight + objectMarginBottom);
                
                var width = clazz.count > 0 ? objectWidth * clazz.count + (clazz.count - 1) * objectMarginRight : objectWidth;
                
                clazz.x = x + (width - objectWidth) / 2;
                clazz.y = y;
                clazz.width = width;
                
                html += drawObject(clazz);
                
                if(clazz.implements){
                    html += drawVerticalCircle(clazz.x + objectWidth / 2 + implementOffset, clazz.y - implementHeight, implementHeight);
                    html += drawText(clazz.implements.join(','), clazz.x + objectWidth / 2 + implementOffset + 18, clazz.y - implementHeight - 4);
                }
                
                // 如果有子对象。画一个继承的箭头。
                if(clazz.count > 0){
                    
                    for(var i = 0; i < clazz.children.length; i++){
                        drawSignleObject(clazz.children[i]);
                    }
                    
                    html += drawVerticalArrow(x + width / 2, y + objectHeight, objectMarginBottom / 2);
                    
                    y = y + objectHeight + objectMarginBottom / 2;
                    
                    html += drawHorizonalLine(clazz.children[0].x + objectWidth / 2, y, clazz.children[clazz.children.length - 1].x - clazz.children[0].x);
                    
                    for(var i = 0; i < clazz.children.length; i++){
                        
                        html += drawVerticalLine(clazz.children[i].x + objectWidth / 2, y, objectMarginBottom / 2);
                    
                    }
                }
                
            }
            
            document.getElementById('body').innerHTML = html;

        }

        // 绘图底层

        function drawObject(clazz) {
            var html = '';
            html += '<aside class="object collapsed1" style="left:' + clazz.x + 'px;top:' + clazz.y + 'px"><header><div class="collapse"></div><h4>' + clazz.name + '</h4><div class="type">' + (clazz.type || '对象') + '</div>';
            
            if(clazz.extend){
                html += '<div><span class="rightarrow"></span><a href="#">' + clazz.extend +'</a></div>';
            }
            
            html += '</header><dl>';
            
            for(var memberType in members){
                
                var t = clazz[memberType + 's'];
                
                if(t){
                    html += '<dt>' + members[memberType] + '</dt>';
                    
                    for(var field in clazz[memberType + 's']){
                        html += '<dd><span class="icon-member icon-' + (t[field].static ? 'static' : 'none') +'"></span><span class="icon-member icon-' + memberType + '"></span><a href="#" class="member-' + t[field].attribute + '">' + field + '</a></dd>';
                    }
                }
            }
            
            html += '</dl></aside>';
            
            return html;
        }

        function drawHorizonalLine(x, y, width) {
            return '<div class="line-horizonal" style="top:' + y + 'px;left:' + x + 'px;width:' + width + 'px"></div>';
        }

        function drawVerticalLine(x, y, height) {
            return '<div class="line-vertical" style="left:' + x + 'px;top:' + y + 'px;height:' + height + 'px"></div>';
        }

        function drawVerticalArrow(x, y, height) {
            
            return '<div class="arrow-top" style="left:' + (x - 5) + 'px;top:' + y + 'px;">△</div>' + drawVerticalLine(x, y + 12, height - 12) ;
        }

        function drawText(text, x, y) {
            
            return '<div style="left:' + (x - 5) + 'px;top:' + y + 'px;">' + text + '</div>' ;
        }

        function drawVerticalCircle(x, y, height) {
            
            return '<div class="arrow-circle" style="left:' + (x - 5) + 'px;top:' +  (y - 12) + 'px;">◦</div>' + drawVerticalLine(x, y + 12, height - 12) ;
        }

        function testDraw(func, args0, args1, args2) {
            var func = arguments[0];
            document.getElementById('body').innerHTML = func.call(this, args0, args1, args2);
        }

    </script>
</head>
<body>
    <article class="demo">

        <div id="body">
        </div>

        <aside class="object">
            <header>
                <div class="collapse">
                </div>
                <h4>Class</h4>
                <div>类</div>
                <div><span class="rightarrow"></span><a href="#">Class</a></div>
            </header>
            <dl>
                <dt>字段</dt>
                <dd>
                    <span class="icon-member icon-static"></span><span class="icon-member icon-field"></span><a href="#">aaa</a>
                </dd>
                <dt>方法</dt>
                <dd>
                    <span class="icon-member icon-none"></span><span class="icon-member icon-method"></span><a href="#">aaa</a>
                </dd>
                <dd>
                    <span class="icon-member icon-static"></span><span class="icon-member icon-method"></span><a href="#">aaa</a>
                </dd>
                <dt>事件</dt>
                <dd>
                    <span class="icon-member icon-none"></span><span class="icon-member icon-event"></span><a href="#">aaa</a>
                </dd>
            </dl>
        </aside>

        <aside class="object collapsed" style="left: 44px">
            <header>
                <div class="collapse">
                </div>
                <h4>Class</h4>
                <div>类</div>
            </header>
            <dl>
                <dd>
                    <a href="#">aaa</a>
                </dd>
            </dl>
        </aside>

        <aside class="source">
            <span class="arrow"><span class="arrow-fore">◆</span></span>
            <pre class="sh">AAAA</pre>
        </aside>

        <div class="arrow-top">
            △
        </div>
        <div class="arrow-circle">
            ◦
        </div>
        <div class="line-horizonal">
           
        </div>
        <div class="line-vertical">
            
        </div>
        
        <script>
            var a = getClasses();
            
            paintClassDom(a);
            
            
            
            
        </script>
    </article>

</body>
</html>
